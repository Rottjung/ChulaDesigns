<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brood Bakery Calculator</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.5rem;
    }
    td, th {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background: #eee;
    }
    select, input {
      padding: 0.3rem;
      margin: 0.3rem 0;
    }
  </style>
</head>
<body>
  <h1>Brood Bakery Calculator</h1><label>Choose Recipe: <select id="recipeSelect"></select> </label> <br /> <label>Input Type: <select id="inputType"> <option value="dough">Total Dough Weight</option> <option value="flour">Flour Only</option> </select> </label> <input id="inputAmount" type="number" placeholder="g" value="1000" /> <br />

  <h3>Ingredients</h3>
  <table>
    <thead>
      <tr><th>Ingredient</th><th>Baker's %</th><th>Amount (g)</th><th>Brand</th><th>Cost (THB)</th></tr>
    </thead>
    <tbody id="ingredientTable"></tbody>
  </table>  <h3>Extras (per item)</h3>
  <table>
    <thead>
      <tr><th>Ingredient</th><th>Grams per Item</th><th>Brand</th><th>Cost per Item (THB)</th></tr>
    </thead>
    <tbody id="extraTable"></tbody>
  </table>  <h2 id="totalCost">Total Ingredient Cost: 0 THB</h2>  <script>
    let recipes = {}, prices = {};

    const recipeSelect = document.getElementById("recipeSelect");
    const inputType = document.getElementById("inputType");
    const inputAmount = document.getElementById("inputAmount");
    const ingredientTable = document.getElementById("ingredientTable");
    const extraTable = document.getElementById("extraTable");
    const totalCostEl = document.getElementById("totalCost");

    const brandSelections = {}; // { ingredient: selectedBrand }

    function loadJSON(name) {
      return fetch(name).then(r => r.json());
    }

    function populateRecipeList() {
      Object.keys(recipes).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        recipeSelect.appendChild(opt);
      });
    }

    function getBrandPrice(ingr, brand) {
      const item = prices[ingr];
      if (!item) return 0;
      if (brand && item[brand]) return item[brand];
      return Object.values(item)[0];
    }

    function updateBrandDropdown(cell, ingrName, selectedBrand) {
      const priceInfo = prices[ingrName];
      if (!priceInfo) return;

      const select = document.createElement("select");
      Object.keys(priceInfo).forEach(brand => {
        const opt = document.createElement("option");
        opt.value = brand;
        opt.textContent = brand;
        if (brand === selectedBrand) opt.selected = true;
        select.appendChild(opt);
      });

      select.onchange = () => {
        brandSelections[ingrName] = select.value;
        render();
      };
      cell.appendChild(select);
    }

    function render() {
      const recipe = recipes[recipeSelect.value];
      if (!recipe) return;

      const total = parseFloat(inputAmount.value);
      const useFlour = inputType.value === "flour";

      ingredientTable.innerHTML = "";
      extraTable.innerHTML = "";
      let totalCost = 0;

      const totalPct = recipe.ingredients.reduce((sum, i) => sum + parseFloat(i.bakersPercent), 0);
      const flourBase = useFlour ? total : total * 100 / totalPct;

      recipe.ingredients.forEach(i => {
        const row = document.createElement("tr");
        const grams = flourBase * parseFloat(i.bakersPercent) / 100;
        const brand = brandSelections[i.name] || Object.keys(prices[i.name] || {})[0] || "";
        const cost = (getBrandPrice(i.name, brand) || 0) * grams / 1000;
        totalCost += cost;

        row.innerHTML = `
          <td>${i.name}</td>
          <td>${parseFloat(i.bakersPercent).toFixed(1)}%</td>
          <td>${grams.toFixed(1)}</td>
          <td></td>
          <td>${cost.toFixed(2)}</td>
        `;

        updateBrandDropdown(row.cells[3], i.name, brand);
        ingredientTable.appendChild(row);
      });

      (recipe.extras || []).forEach(i => {
        const row = document.createElement("tr");
        const brand = brandSelections[i.name] || Object.keys(prices[i.name] || {})[0] || "";
        const cost = (getBrandPrice(i.name, brand) || 0) * parseFloat(i.perUnitGrams) / 1000;

        row.innerHTML = `
          <td>${i.name}</td>
          <td>${i.perUnitGrams}</td>
          <td></td>
          <td>${cost.toFixed(2)}</td>
        `;

        updateBrandDropdown(row.cells[2], i.name, brand);
        extraTable.appendChild(row);
      });

      totalCostEl.textContent = `Total Ingredient Cost: ${totalCost.toFixed(2)} THB`;
    }

    Promise.all([loadJSON("recipes.json"), loadJSON("ingredientPrices.json")])
      .then(([r, p]) => {
        recipes = r;
        prices = p;
        populateRecipeList();
        render();
      });

    recipeSelect.onchange = render;
    inputAmount.oninput = render;
    inputType.onchange = render;
  </script></body>
</html>
