<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>-=BROOD=- Bakery Calculator</title>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    select, input[type="number"] { margin: 5px; width: 80px; }
    table { margin: 0 auto; }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 6px; }
    h1 { margin-bottom: 0; }
    h2, h3 { margin-top: 40px; }
  </style>
</head>
<body>
  <h1>- = BROOD = -</h1>
  <h2>Bakery Calculator</h2><label for="recipe-select">Choose Recipe:</label> <select id="recipe-select" onchange="handleRecipeChange()"></select><br />

<label for="input-type">Input Type:</label> <select id="input-type" onchange="handleRecipeChange()"> <option value="dough">Total Dough Weight</option> <option value="flour">Flour Only</option> </select> <input type="number" id="input-grams" value="1000" oninput="handleRecipeChange()"> g

  <h3>Ingredients</h3>
  <table id="ingredients-table">
    <thead>
      <tr><th>Ingredient</th><th>Amount (g)</th><th>Baker's %</th><th>Brand</th><th>Cost (THB)</th></tr>
    </thead>
    <tbody></tbody>
  </table>  <h3>Extras (per item)</h3>
  <table id="extras-table">
    <thead>
      <tr><th>Ingredient</th><th>Grams per Item</th><th>Brand</th><th>Cost per Item (THB)</th></tr>
    </thead>
    <tbody></tbody>
  </table>  <h2>Total Ingredient Cost: <span id="total-cost">0</span> THB</h2>  <h3>Suggested Price</h3>
  <div style="display:inline-block; text-align:left;">
    <label>Items/day: <input type="number" id="items-per-day" value="175" oninput="handleRecipeChange()"></label><br>
    <label>Labor hrs/day: <input type="number" id="labor-hours" value="12" oninput="handleRecipeChange()"></label><br>
    <label>Hourly wage: <input type="number" id="hourly-wage" value="50" oninput="handleRecipeChange()"></label><br>
    <label>Electricity/month: <input type="number" id="elec" value="3600" oninput="handleRecipeChange()"></label><br>
    <label>Water/month: <input type="number" id="water" value="200" oninput="handleRecipeChange()"></label><br>
    <label>Gas/month: <input type="number" id="gas" value="430" oninput="handleRecipeChange()"></label><br>
    <label>Markup x: <input type="number" step="0.1" id="markup-mult" value="3" oninput="handleRecipeChange()"></label>
  </div>
  <h2>Suggested Price: <span id="suggested-price">0</span> THB</h2>  <script>
    let recipes = [];
    let prices = {};

    function loadJSON(file, callback) {
      fetch(file + '?cacheBust=' + new Date().getTime())
        .then(res => res.json())
        .then(callback)
        .catch(err => alert("Failed to load " + file));
    }

    function showPopup(text) {
      const popup = document.createElement("div");
      popup.textContent = text;
      popup.style.position = "fixed";
      popup.style.top = `${20 + document.querySelectorAll('.popup').length * 30}px`;
      popup.style.left = "50%";
      popup.style.transform = "translateX(-50%)";
      popup.style.background = "#333";
      popup.style.color = "#fff";
      popup.style.padding = "5px 10px";
      popup.style.borderRadius = "4px";
      popup.className = "popup";
      document.body.appendChild(popup);
      setTimeout(() => popup.remove(), 2000);
    }

    function populateRecipeSelect() {
      const select = document.getElementById("recipe-select");
      select.innerHTML = "";
      recipes.forEach((r, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = r.name;
        select.appendChild(opt);
      });
      if (recipes.length > 0) {
        select.selectedIndex = 0;
        handleRecipeChange();
      }
    }

    function handleRecipeChange() {
      const recipe = recipes[document.getElementById("recipe-select").value];
      const inputType = document.getElementById("input-type").value;
      const inputGrams = parseFloat(document.getElementById("input-grams").value);
      if (!recipe || isNaN(inputGrams)) return;

      const flourWeight = inputType === "flour" ? inputGrams : inputGrams / (1 + recipe.ingredients.reduce((s, i) => s + (i.percent / 100), 0) - 1);

      const ingBody = document.querySelector("#ingredients-table tbody");
      ingBody.innerHTML = "";
      let totalCost = 0;

      recipe.ingredients.forEach(i => {
        const row = document.createElement("tr");
        const amount = flourWeight * i.percent / 100;
        const brands = Object.keys(prices[i.name] || {});
        const brand = brands[0] || "";
        const cost = (prices[i.name]?.[brand] || 0) * amount / 1000;
        totalCost += cost;

        row.innerHTML = `<td>${i.name}</td><td>${amount.toFixed(1)}</td><td>${i.percent}</td>
          <td><select onchange="updateBrand(this, '${i.name}', ${amount}, this.parentElement.nextElementSibling)">
          ${brands.map(b => `<option value="${b}">${b}</option>`).join("")}</select></td>
          <td>${cost.toFixed(2)}</td>`;
        ingBody.appendChild(row);
      });

      const extBody = document.querySelector("#extras-table tbody");
      extBody.innerHTML = "";
      recipe.extras.forEach(e => {
        const brands = Object.keys(prices[e.name] || {});
        const brand = brands[0] || "";
        const cost = (prices[e.name]?.[brand] || 0) * e.perUnitGrams / 1000;
        totalCost += cost;

        const row = document.createElement("tr");
        row.innerHTML = `<td>${e.name}</td>
          <td><input type="number" value="${e.perUnitGrams}" style="width:60px;" oninput="updateExtraGrams(this, '${e.name}')"></td>
          <td><select onchange="updateBrand(this, '${e.name}', ${e.perUnitGrams}, this.parentElement.nextElementSibling)">
          ${brands.map(b => `<option value="${b}">${b}</option>`).join("")}</select></td>
          <td>${cost.toFixed(2)}</td>`;
        extBody.appendChild(row);
      });

      document.getElementById("total-cost").textContent = totalCost.toFixed(2);
      calculateSuggestedPrice(totalCost);
    }

    function updateExtraGrams(input, name) {
      const recipe = recipes[document.getElementById("recipe-select").value];
      const extra = recipe.extras.find(e => e.name === name);
      if (!extra) return;
      extra.perUnitGrams = parseFloat(input.value);
      handleRecipeChange();
    }

    function updateBrand(sel, name, amount, costTd) {
      const brand = sel.value;
      const price = prices[name]?.[brand] || 0;
      const cost = price * amount / 1000;
      costTd.textContent = cost.toFixed(2);
      showPopup(`${name} updated`);
      handleRecipeChange();
    }

    function calculateSuggestedPrice(baseCost) {
      const items = parseFloat(document.getElementById("items-per-day").value);
      const hours = parseFloat(document.getElementById("labor-hours").value);
      const wage = parseFloat(document.getElementById("hourly-wage").value);
      const markup = parseFloat(document.getElementById("markup-mult").value);
      const elec = parseFloat(document.getElementById("elec").value);
      const water = parseFloat(document.getElementById("water").value);
      const gas = parseFloat(document.getElementById("gas").value);

      const util = (elec + water + gas) / 30 / items; // per day, per item
      const labor = (hours * wage) / items;
      const total = (baseCost + util + labor) * markup;
      document.getElementById("suggested-price").textContent = total.toFixed(2);
    }

    loadJSON("recipes.json", data => { recipes = data; showPopup("Recipes loaded"); populateRecipeSelect(); });
    loadJSON("ingredientPrices.json", data => { prices = data; showPopup("Prices loaded"); });
  </script></body>
</html>
